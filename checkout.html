<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>結帳 - 竹意軒的咖啡工坊</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #FDFBF8; }
        .form-input { appearance: none; border: 1px solid #D1D5DB; border-radius: 0.375rem; padding: 0.75rem 1rem; width: 100%; transition: box-shadow 0.2s, border-color 0.2s; }
        .form-input:focus { outline: none; border-color: #A0522D; box-shadow: 0 0 0 3px rgba(160, 82, 45, 0.2); }
    </style>
</head>
<body>

    <header class="bg-white/90 backdrop-blur-md sticky top-0 z-50 shadow-sm">
        <nav class="container mx-auto px-6 py-3">
            <div class="flex justify-between items-center">
                <div class="text-xl font-bold text-gray-800">
                    <span class="text-amber-800">C.</span> 竹意軒的咖啡工坊
                </div>
                <div>
                    <a href="index.html" class="text-gray-600 hover:text-amber-800">返回首頁繼續購物</a>
                </div>
            </div>
        </nav>
    </header>

    <main class="container mx-auto px-6 py-12">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-16">
            
            <section>
                <button id="back-btn" class="text-gray-600 hover:text-amber-800 mb-6">&larr; 返回上一步</button>
                <h2 id="form-title" class="text-3xl font-bold text-gray-800 mb-8">載入中...</h2>

                <form id="home-delivery-form" style="display: none;" class="space-y-6">
                    <div>
                        <label for="delivery-name" class="block text-sm font-medium text-gray-700 mb-2">收件人姓名</label>
                        <input type="text" id="delivery-name" name="name" required class="form-input">
                    </div>
                    <div>
                        <label for="delivery-phone" class="block text-sm font-medium text-gray-700 mb-2">行動電話</label>
                        <input type="tel" id="delivery-phone" name="phone" required class="form-input" placeholder="請輸入 09 開頭的 10 位數字">
                        </div>
                    <div>
                        <label for="delivery-address" class="block text-sm font-medium text-gray-700 mb-2">郵寄地址</label>
                        <input type="text" id="delivery-address" name="address" required class="form-input">
                    </div>
                </form>

                <form id="cvs-form" style="display: none;" class="space-y-6">
                     <div>
                        <label for="cvs-name" class="block text-sm font-medium text-gray-700 mb-2">取件人姓名</label>
                        <input type="text" id="cvs-name" name="name" required class="form-input">
                    </div>
                    <div>
                        <label for="cvs-phone" class="block text-sm font-medium text-gray-700 mb-2">取件人行動電話</label>
                        <input type="tel" id="cvs-phone" name="phone" required class="form-input" placeholder="請輸入 09 開頭的 10 位數字">
                    </div>
                    <div>
                         <label class="block text-sm font-medium text-gray-700 mb-2">取貨門市</label>
                         <div id="selected-store-info" class="p-4 bg-gray-100 rounded-md text-gray-700 min-h-[50px]">尚未選擇門市</div>
                         <button type="button" id="select-store-btn" class="mt-2 bg-white border border-gray-300 hover:bg-gray-50 text-gray-800 font-bold py-2 px-4 rounded-lg">
                            選擇超商門市
                         </button>
                    </div>
                    <div class="border-t pt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">付款方式</label>
                        <div class="space-y-2">
                             <label class="flex items-center"><input type="radio" name="payment" value="CreditCard" checked class="h-4 w-4 text-amber-600 border-gray-300 focus:ring-amber-500"> <span class="ml-2">信用卡付款</span></label>
                             <label class="flex items-center"><input type="radio" name="payment" value="COD" class="h-4 w-4 text-amber-600 border-gray-300 focus:ring-amber-500"> <span class="ml-2">取貨付款</span></label>
                        </div>
                    </div>
                </form>

            </section>

            <aside class="bg-white p-8 rounded-lg shadow-md h-fit">
                <h3 class="text-2xl font-bold border-b pb-4 mb-6">訂單摘要</h3>
                <div id="summary-items" class="space-y-4 mb-6">
                    </div>
                <div class="border-t pt-4 space-y-3">
                    <div class="flex justify-between"><span>商品小計</span><span id="summary-subtotal">NT$ 0</span></div>
                    <div class="flex justify-between"><span>運費</span><span id="summary-shipping">NT$ 0</span></div>
                    <div class="flex justify-between font-bold text-xl"><span>總計</span><span id="summary-total">NT$ 0</span></div>
                </div>
                <button id="confirm-order-btn" class="w-full mt-8 bg-amber-800 hover:bg-amber-900 text-white font-bold py-3 px-4 rounded-lg transition-colors">
                    確認訂購
                </button>
            </aside>
        </div>
    </main>
     <form id="ecpay-map-form" method="POST" action="https://payment-stage.ecpay.com.tw/Cashier/ExpressMap" target="_blank" style="display: none;">
        <input type="hidden" name="MerchantID" />
        <input type="hidden" name="LogisticsType" value="CVS" />
        <input type="hidden" name="LogisticsSubType" value="UNIMART" /> <input type="hidden" name="IsCollection" value="Y" />
        <input type="hidden" name="ServerReplyURL" />
        <input type="hidden" name="ClientReplyURL" />
    </form>

    <script src="https://payment-stage.ecpay.com.tw/Scripts/sdk/ecpay.sdk.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- 1. 獲取所有需要的 HTML 元素 ---
        const shippingMethod = localStorage.getItem('shippingMethod');
        const cart = JSON.parse(localStorage.getItem('bamboo_cart') || '[]');

        // 表單區
        const formTitle = document.getElementById('form-title');
        const homeDeliveryForm = document.getElementById('home-delivery-form');
        const cvsForm = document.getElementById('cvs-form');
        const backBtn = document.getElementById('back-btn');
        const confirmOrderBtn = document.getElementById('confirm-order-btn');

        // 訂單摘要區
        const summaryItems = document.getElementById('summary-items');
        const summarySubtotal = document.getElementById('summary-subtotal');
        const summaryShipping = document.getElementById('summary-shipping');
        const summaryTotal = document.getElementById('summary-total');
        
        // 超商地圖相關元素
        const selectStoreBtn = document.getElementById('select-store-btn');
        const ecpayMapForm = document.getElementById('ecpay-map-form');
        const selectedStoreInfoDiv = document.getElementById('selected-store-info');

        // --- 2. 初始化狀態變數 ---
        let selectedStore = null; // 用來儲存使用者選擇的門市資訊

        // --- 3. 頁面初始設定 ---

        // 如果沒有配送資訊或購物車是空的，就跳轉回首頁
        if (!shippingMethod || cart.length === 0) {
            window.location.href = 'index.html';
            return;
        }

        // 根據配送方式，顯示對應的表單
        if (shippingMethod === 'HOME_DELIVERY') {
            formTitle.textContent = '郵寄宅配資訊';
            homeDeliveryForm.style.display = 'block';
        } else if (shippingMethod === 'CVS') {
            formTitle.textContent = '超商取貨資訊';
            cvsForm.style.display = 'block';
        }
        
        // 返回按鈕功能
        backBtn.addEventListener('click', () => {
            window.history.back();
        });

        // --- 4. 渲染訂單摘要 (計算金額) ---
        let subtotal = 0;
        summaryItems.innerHTML = '';
        cart.forEach(item => {
            subtotal += item.price * item.quantity;
            const itemEl = document.createElement('div');
            itemEl.className = 'flex justify-between text-gray-600';
            itemEl.innerHTML = `<span>${item.name} x${item.quantity}</span><span>NT$ ${item.price * item.quantity}</span>`;
            summaryItems.appendChild(itemEl);
        });
        
        const shippingFee = subtotal >= 1000 ? 0 : (shippingMethod === 'CVS' ? 60 : 80);
        const total = subtotal + shippingFee;

        summarySubtotal.textContent = `NT$ ${subtotal}`;
        summaryShipping.innerHTML = subtotal >= 1000 ? `NT$ <del>${shippingMethod === 'CVS' ? 60 : 80}</del> 0 (已達免運門檻)` : `NT$ ${shippingFee}`;
        summaryTotal.textContent = `NT$ ${total}`;

        // --- 5. 串接綠界地圖的邏輯 ---

        // A. 點擊「選擇超商門市」按鈕時，觸發地圖
        selectStoreBtn.addEventListener('click', () => {
            const merchantIDInput = ecpayMapForm.querySelector('input[name="MerchantID"]');
            const serverReplyURLInput = ecpayMapForm.querySelector('input[name="ServerReplyURL"]');
            
            // ❗❗❗ 請注意：請將這裡的資訊換成您自己的 ❗❗❗
            merchantIDInput.value = '3002607'; // 【必要】請填入您在 .env 檔案中設定的【測試用商店代號】
            serverReplyURLInput.value = 'https://bamboocoffee-shop-ec.netlify.app/'; // 【必要】請務必將 'bamboocoffee.netlify.app' 換成您自己的 Netlify 網站部署後的網址

            ecpayMapForm.submit();
        });

        // B. 監聽從地圖彈出視窗回傳的門市資料
        window.addEventListener('message', (event) => {
            if (event.data && event.data.action === 'ecpayStoreSelected') {
                selectedStore = event.data.store;
                console.log('已選擇門市：', selectedStore);
                
                selectedStoreInfoDiv.innerHTML = `
                    <p class="font-bold">${selectedStore.CVSStoreName} (${selectedStore.CVSStoreCode})</p>
                    <p class="text-sm">${selectedStore.CVSAddress}</p>
                `;
                selectedStoreInfoDiv.classList.remove('text-gray-700');
                selectedStoreInfoDiv.classList.add('text-green-800'); // 改為綠色，提示已選擇
            }
        }, false);


        // --- 6. 「確認訂購」按鈕的最終驗證邏輯 ---
        confirmOrderBtn.addEventListener('click', () => {
            let isValid = true;
            let orderPayload = {}; // 準備要送到後端的完整訂單資料

            if (shippingMethod === 'HOME_DELIVERY') {
                const name = document.getElementById('delivery-name').value.trim();
                const phone = document.getElementById('delivery-phone').value.trim();
                const address = document.getElementById('delivery-address').value.trim();
                
                const phoneRegex = /^09\d{8}$/;
                if (!phoneRegex.test(phone)) {
                    alert('請輸入正確的 10 碼行動電話號碼 (例如 0912345678)。');
                    isValid = false;
                }
                if (!name || !phone || !address) {
                    alert('請確實填寫所有收件資訊。');
                    isValid = false;
                }
                
                orderPayload = { name, phone, address };

            } else if (shippingMethod === 'CVS') {
                const name = document.getElementById('cvs-name').value.trim();
                const phone = document.getElementById('cvs-phone').value.trim();
                const paymentMethod = document.querySelector('input[name="payment"]:checked').value;
                
                const phoneRegex = /^09\d{8}$/;
                if (!phoneRegex.test(phone)) {
                    alert('請輸入正確的 10 碼行動電話號碼 (例如 0912345678)。');
                    isValid = false;
                }
                if (!name || !phone) {
                    alert('請確實填寫取件人姓名與電話。');
                    isValid = false;
                }
                if (!selectedStore) {
                    alert('請選擇一間超商取貨門市。');
                    isValid = false;
                }
                
                orderPayload = { name, phone, store: selectedStore, paymentMethod };
            }

            if (!isValid) { return; }

            console.log('表單驗證通過！準備送到後端的資料：', {
                cart: cart,
                shippingMethod: shippingMethod,
                recipientInfo: orderPayload,
                orderTotal: total
            });
            alert('驗證通過！下一步，我們將會在這裡呼叫後端函式！');
            // TODO: 呼叫 Netlify Function
        });
    });
</script>
</body>
</html>